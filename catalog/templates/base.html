<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Title of each page -->
  <title>{% block title %}{% endblock %}</title>

  {% load notifications_tags %}
  {% load static %}

  <!-- CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
  <!-- Page specific stylesheets -->
  {% block css %}{% endblock %}
</head>

<body>
  <!-- Vertical navigation bar -->
  <div class="navbar" id="mainNavbar">
    <a href="{% url 'index' %}"><i class="fa fa-fw fa-home"></i>Home</a>
    <a href="{% url 'genres' %}">Genres</a>
    <a href="{% url 'studios' %}">Studios</a>

    <!-- Anime dropdown (hoverable) -->
    <div class="hoverable-dropdown">
      <button class="hoverable-dropbtn">Anime
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="hoverable-dropdown-content">
        <a href="{% url 'airing-anime' %}">Currently Airing Anime</a>
        <a href="{% url 'anime' %}">All Anime</a>
      </div>
    </div>

    <!-- Check if user is authenticated -->
    {% if user.is_authenticated %}
      <!-- Store notifications info -->
      {% notifications_unread as unread_count %}
      {% live_notify_badge as  live_unread_count%}
      {% live_notify_list as live_unread_notifications %}
      {% register_notify_callbacks callbacks='fill_notification_list,fill_notification_badge' %}

      <!-- Notifications dropdown (clickable) -->
      <div class="clickable-dropdown">
        <button onclick="toggle_content()" class="clickable-dropbtn">
          <i class="fas fa-bell"></i>
          {% if live_unread_count != 0 %}
            <span class="badge">{{ live_unread_count }}</span>
          {% endif %}
        </button>

        <div id="notificationsDropdown" class="clickable-dropdown-content">
          {% for notification in user.notifications.unread %}
            <a href="{% url 'index' %}">{{ notification.verb }}</a>
          {% endfor %}
          <button type="button" class="mark_all_read">Mark all as read</button>
        </div>
      </div>

      <!-- User information dropdown (hoverable) -->
      <div class="hoverable-dropdown">
        <button class="hoverable-dropbtn">
          <i class="fa fa-fw fa-user"></i>
          {{ user.get_username }}
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="hoverable-dropdown-content">
          <a href="{% url 'user-page' %}">My Profile</a>
          <a href="{% url 'my-watchlist' %}">Watchlist</a>
          <a href="{% url 'logout'%}?next={{request.path}}">Logout</a>
        </div>
      </div>
    {% else %}
       <a href="{% url 'login'%}?next={{request.path}}"><i class="fa fa-fw fa-user"></i>Login</a>
    {% endif %}
  </div>

  <!-- Page specific content -->
  <div class="col-sm-10 ">{% block content %}{% endblock %}</div>

  <!-- JS -->
  <script src="{% static 'js/dropdown_content.js' %}"></script>
  <script src="{% static 'notifications/notify.js' %}" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <!-- ajax for 'Mark all as read' button -->
  <script>
    $('.mark_all_read').click(function(){
        $.ajax({
            type: "POST",
            url: "{% url "notifications:mark_all_as_read" %}",
            data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
            dataType: "json",
            success: function() {
                $(this).css("color", "grey");
            },
        });
    })
  </script>

  <!-- Page specific scripts -->
  {% block scripts %}{% endblock %}
</body>

</html>
